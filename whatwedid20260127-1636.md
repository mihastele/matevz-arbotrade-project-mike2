# Code Review & Security Patch Report

**Date:** January 27, 2026, 16:36  
**Scope:** Cart logic, authentication flow, payment checkout, security vulnerabilities  
**Issue Reported:** Logged-in users get logged out when clicking "Continue to Payment"

---

## üî¥ Critical Bug Fixed: Logout on Payment Flow

### Root Cause Identified

The bug was located in **frontend/src/api/index.ts** in the Axios response interceptor:

```typescript
// BEFORE (buggy code)
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('accessToken')
      localStorage.removeItem('user')
      window.location.href = '/login'  // ‚ùå Forced redirect on ANY 401
    }
    return Promise.reject(error)
  }
)
```

**Why this caused the bug:**

1. User is logged in with a valid JWT token
2. User clicks "Continue to Payment" 
3. Frontend calls `POST /payments/create-checkout-intent`
4. This endpoint uses `OptionalAuthGuard` (allows both authenticated and guest users)
5. If the JWT token is expired or has any validation issue, Passport throws a 401 error
6. The frontend interceptor catches **ANY** 401 response
7. Even though the backend would accept the request as a guest, the frontend:
   - Clears `accessToken` and `user` from localStorage
   - Force-redirects to `/login`

The `OptionalAuthGuard` on the backend was designed correctly to allow requests to proceed as guest if authentication fails, but the frontend interceptor was too aggressive and killed the session before the request could complete.

### Fix Applied

```typescript
// AFTER (fixed code)
api.interceptors.response.use(
  (response) => response,
  (error) => {
    // Only force logout on 401 for endpoints that strictly require authentication
    // Don't logout for optional-auth endpoints (cart, payments, orders) - these allow guest access
    const optionalAuthPaths = ['/cart', '/payments', '/orders'];
    const requestUrl = error.config?.url || '';
    const isOptionalAuthEndpoint = optionalAuthPaths.some(path => requestUrl.includes(path));
    
    if (error.response?.status === 401 && !isOptionalAuthEndpoint) {
      localStorage.removeItem('accessToken')
      localStorage.removeItem('user')
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)
```

**File Modified:** `frontend/src/api/index.ts`

---

## üîí Security Vulnerabilities Fixed

### 1. Debug Logging with Sensitive Data (HIGH SEVERITY)

**Issue:** Multiple backend files were writing sensitive user data to `debug.txt`:

- User IDs
- Guest tokens  
- JWT payloads
- Request user objects

This could expose:
- User identification information
- Session tokens that could be hijacked
- JWT contents including user roles and permissions

**Files Modified:**

| File | Change |
|------|--------|
| `backend/src/modules/cart/cart.service.ts` | Removed `fs` and `path` imports, removed debug logging |
| `backend/src/modules/payments/payments.controller.ts` | Removed `fs` and `path` imports, removed debug logging |
| `backend/src/modules/auth/strategies/jwt.strategy.ts` | Removed `fs` and `path` imports, removed debug logging |

---

### 2. Hardcoded JWT Fallback Secret (HIGH SEVERITY)

**Issue:** The JWT strategy had a fallback secret:

```typescript
// BEFORE (vulnerable)
secretOrKey: configService.get<string>('JWT_SECRET') || 'fallback-secret',
```

**Risk:** If `JWT_SECRET` environment variable is missing or empty, the application would use `'fallback-secret'` which is:
- Publicly known (in source code)
- Trivially guessable
- Allows attackers to forge valid JWT tokens

**Fix Applied:**

```typescript
// AFTER (secure)
const jwtSecret = configService.get<string>('JWT_SECRET');
if (!jwtSecret) {
  throw new Error('JWT_SECRET environment variable is not set. This is required for secure authentication.');
}
super({
  jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
  ignoreExpiration: false,
  secretOrKey: jwtSecret,
});
```

**File Modified:** `backend/src/modules/auth/strategies/jwt.strategy.ts`

---

### 3. Unauthenticated Order Lookup (MEDIUM SEVERITY)

**Issue:** The `GET /orders/number/:orderNumber` endpoint had no authentication:

```typescript
// BEFORE (vulnerable)
@Get('number/:orderNumber')
@ApiOperation({ summary: 'Get order by order number' })
findByOrderNumber(@Param('orderNumber') orderNumber: string) {
  return this.ordersService.findByOrderNumber(orderNumber);
}
```

**Risk:** Anyone who guesses or obtains an order number could view:
- Customer shipping/billing addresses
- Order items and quantities
- Payment information
- Customer email addresses

**Fix Applied:**

**Controller (`backend/src/modules/orders/orders.controller.ts`):**
```typescript
@Get('number/:orderNumber')
@UseGuards(OptionalAuthGuard)
@ApiBearerAuth()
@ApiHeader({ name: 'x-guest-token', required: false })
@ApiOperation({ summary: 'Get order by order number (requires matching user/guest or admin)' })
findByOrderNumber(
  @Param('orderNumber') orderNumber: string,
  @Request() req: any,
  @Headers('x-guest-token') guestToken: string | undefined,
) {
  return this.ordersService.findByOrderNumber(orderNumber, req.user?.id, guestToken, req.user?.role);
}
```

**Service (`backend/src/modules/orders/orders.service.ts`):**
```typescript
async findByOrderNumber(
  orderNumber: string,
  userId?: string,
  guestToken?: string,
  userRole?: UserRole,
): Promise<Order> {
  const order = await this.ordersRepository.findOne({
    where: { orderNumber },
    relations: ['items', 'items.product', 'items.product.images'],
  });
  if (!order) {
    throw new NotFoundException('Order not found');
  }
  
  // Authorization check: user must be admin, order owner, or guest who created the order
  const isAdmin = userRole === UserRole.ADMIN;
  const isOrderOwner = userId && order.userId === userId;
  const isGuestOrder = !order.userId;
  
  if (!isAdmin && !isOrderOwner && !isGuestOrder) {
    throw new ForbiddenException('You do not have permission to view this order');
  }
  
  return order;
}
```

---

## üìã Summary of All Changes

| File | Type | Change Description |
|------|------|-------------------|
| `frontend/src/api/index.ts` | Bug Fix | Smart 401 handler - skip logout for optional-auth endpoints |
| `backend/src/modules/cart/cart.service.ts` | Security | Removed debug logging with sensitive data |
| `backend/src/modules/payments/payments.controller.ts` | Security | Removed debug logging with sensitive data |
| `backend/src/modules/auth/strategies/jwt.strategy.ts` | Security | Removed debug logging, removed fallback JWT secret |
| `backend/src/modules/orders/orders.controller.ts` | Security | Added auth guard and ownership check to order lookup |
| `backend/src/modules/orders/orders.service.ts` | Security | Added authorization logic to `findByOrderNumber` |

---

## üöÄ Recommended Future Improvements

### High Priority

1. **Implement Token Refresh Flow**
   - Add refresh tokens to extend sessions without re-login
   - Store refresh token in httpOnly cookie for security
   - Auto-refresh access token when it expires
   - Files to modify:
     - `backend/src/modules/auth/auth.service.ts`
     - `backend/src/modules/auth/auth.controller.ts`
     - `frontend/src/stores/auth.ts`
     - `frontend/src/api/index.ts`

2. **Add CSRF Protection**
   - Implement CSRF tokens for state-changing operations
   - Especially important for checkout and payment flows
   - Consider using NestJS CSRF middleware

3. **Rate Limiting**
   - Add rate limiting to sensitive endpoints:
     - Login/Register (`/auth/*`)
     - Payment creation (`/payments/*`)
     - Order creation (`/orders`)
   - Use `@nestjs/throttler` package

### Medium Priority

4. **Secure Guest Token Generation**
   - Current: UUID v4 (predictable pattern)
   - Recommended: Use `crypto.randomBytes(32).toString('hex')` for cryptographically secure tokens

5. **Add Request Logging (Properly)**
   - Use a proper logging framework (Winston, Pino)
   - Configure log levels by environment
   - Redact sensitive data (passwords, tokens, PII)
   - Send logs to centralized logging service in production

6. **Input Validation Hardening**
   - Add more specific validators to DTOs
   - Sanitize user inputs to prevent XSS
   - Add SQL injection protection (already handled by TypeORM, but validate inputs)

### Low Priority

7. **API Versioning**
   - Add API versioning (`/api/v1/...`) for future compatibility

8. **Audit Logging**
   - Log authentication events (login, logout, failed attempts)
   - Log order status changes
   - Log admin actions

9. **Session Management Improvements**
   - Add "Remember me" functionality
   - Implement session invalidation on password change
   - Add concurrent session limit per user

---

## üß™ Testing Recommendations

### Manual Testing Checklist

- [ ] Login as user, add items to cart, click "Continue to Payment" ‚Üí Should stay logged in
- [ ] Let JWT expire while on cart page, click "Continue to Payment" ‚Üí Should proceed as guest (not logout)
- [ ] Try accessing `/orders/number/XXXX` without auth ‚Üí Should work only for guest orders
- [ ] Try accessing another user's order by number ‚Üí Should get 403 Forbidden
- [ ] Start app without `JWT_SECRET` env var ‚Üí Should fail to start with clear error

### Automated Test Suggestions

1. Add integration tests for the 401 interceptor behavior
2. Add E2E tests for the checkout flow with expired tokens
3. Add unit tests for `findByOrderNumber` authorization logic

---

## üìù Notes

- The `debug.txt` file in the project root may contain previously logged sensitive data and should be deleted
- Ensure `JWT_SECRET` is set in all environments (development, staging, production)
- Consider rotating the JWT secret after this security update
- Review any other files that might be using `fs.appendFileSync` for debug logging

---

*Report generated as part of cart logic code review and security audit.*
